<th:block th:replace="~{usr/common/head}"/>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <style>
        html {
            background-color: #FFFEF0;
        }
        /* body 요소에 좌우 여백 추가 */
        body {
            margin: 0 100px; /* 좌우 여백 100px 설정 */
        }
        /* 팝업 창 스타일 */
        .modal {
            display: none; /* 기본적으로 숨김 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4); /* 배경 어둡게 */
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Flexbox를 사용하여 두 요소를 정렬하는 부모 요소 */
        .flex-container {
            display: flex; /* Flexbox 사용 */
            justify-content: space-between; /* 양쪽 끝으로 배치 */
            margin: 20px; /* 여백 추가 */
        }
        /* calendar 스타일 */
        #calendar {
            border: 1px solid #ccc;
            height: 600px; /* 자동 높이 설정 */
            width: 800px; /* 적절한 너비 설정 */
            border-radius: 5px;
            background-color: #F2F2EB;
            padding: 10px; /* 내부 여백 추가 */
            position: relative; /* 자식 요소의 절대 위치를 위한 상대 위치 */
        }
        /* list 스타일 */
        #List {
            border: 1px solid #ccc;
            height: 600px;
            width: 800px;
            border-radius: 5px; /* 네모박스에 모서리 둥글게 */
            background-color: #F2F2EB;
        }
        /* 이미지 크기를 150px로 설정 */
        .product-image {
            width: auto; /* 너비는 자동으로 비율에 맞게 조정 */
            height: 150px; /* 높이를 150px로 설정 */
        }
        /* 결과 리스트 스타일 */
        #resultContainer {
            list-style-type: none; /* 기본 리스트 스타일 제거 */
            padding: 0; /* 패딩 제거 */
            border: 1px solid #ccc; /* 전체 리스트에 테두리 추가 */
            border-radius: 5px; /* 네모박스에 모서리 둥글게 */
            overflow: hidden; /* 내부 내용이 넘치지 않게 설정 */
            background-color: #F2F2EB;
        }
        /* 리스트 항목 스타일 */
        .product-item {
            padding: 10px; /* 내부 여백 설정 */
            border-bottom: 1px solid #ccc; /* 항목 사이에 선 추가 */
            display: flex; /* Flexbox 사용 */
            align-items: center; /* 세로 중앙 정렬 */
        }
        /* 마지막 항목에서 하단 선 제거 */
        .product-item:last-child {
            border-bottom: none; /* 마지막 항목의 하단 선 제거 */
        }
        /* 제목과 가격을 포함하는 컨테이너 스타일 */
        .product-info {
            margin-left: 10px; /* 이미지와의 간격 설정 */
        }
        /* 링크 스타일 */
        .product-info a {
            text-decoration: none; /* 밑줄 제거 */
            color: black; /* 텍스트 색상 (검정색) */
        }
        /* 가격 스타일 */
        .product-price {
            font-size: 1.5em; /* 글자 크기를 H3 정도로 설정 (약 1.5em) */
            margin: 0; /* 기본 마진 제거 */
        }
        /* 페이지네이션 스타일 */
        .pagination {
            margin-top: 20px; /* 페이지네이션과 상품 리스트 간격 */
            display: flex;
            justify-content: center; /* 중앙 정렬 */
        }
        .page-item {
            margin: 0 5px; /* 페이지 아이템 간격 */
            cursor: pointer; /* 커서 포인터 */
            padding: 5px 10px; /* 여백 설정 */
            border: 1px solid #ccc; /* 테두리 */
            border-radius: 5px; /* 모서리 둥글게 */
        }
        button {
            background: none; /* 버튼 배경 제거 */
            border: none; /* 버튼 테두리 제거 */
            cursor: pointer; /* 커서 포인터 */
            padding: 5px 10px; /* 여백 설정 */
        }
        #sortButtons {
            display: flex;
            justify-content: flex-end; /* 버튼들을 오른쪽에 배치 */
        }
    </style>
</head>
<body>
<div id="root"></div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        let selectedDate = null; // 선택된 날짜를 저장할 변수
        let selectedEvent = null; // 선택된 일정을 저장할 변수

        var calendar = new FullCalendar.Calendar(calendarEl, {
            timeZone: 'UTC',
            initialView: 'dayGridMonth',
            editable: true,
            selectable: true,
            locale: 'ko',
            headerToolbar: {
                start: 'prev',
                center: 'title',
                end: 'next'
            },

// 달력 날짜 클릭 시 팝업 열고 날짜 저장
            dateClick: function(info) {
                selectedDate = info.dateStr; // 클릭한 날짜를 저장
                openPopup(); // 팝업 열기
            }
        });
        // 달력에서 일정을 클릭했을 때 팝업을 여는 함수
        calendar.on('eventClick', function(info) {
            selectedEvent = info.event; // 클릭한 이벤트를 저장
            document.getElementById("itemName").value = selectedEvent.title; // 일정 제목을 팝업에 표시

            // 팝업을 수정 모드로 열기
            openPopup(true); // true 인자를 통해 수정 모드 활성화
        });
        calendar.render();

        // 팝업 열기 및 닫기 기능
        const modal = document.getElementById("schedulePopup");
        const closeBtn = document.querySelector(".close");

        function openPopup(isEditMode = false) {
            // 팝업 열기
            document.getElementById("schedulePopup").style.display = "block";

            if (isEditMode) {
                // 수정 모드일 때
                document.getElementById("createScheduleBtn").style.display = "none"; // 일정 생성 버튼 숨김
                document.getElementById("updateScheduleBtn").style.display = "block"; // 일정 수정 버튼 보임
            } else {
                // 생성 모드일 때
                document.getElementById("createScheduleBtn").style.display = "block"; // 일정 생성 버튼 보임
                document.getElementById("updateScheduleBtn").style.display = "none"; // 일정 수정 버튼 숨김
            }
        }

        function closePopup() {
            // 팝업 닫기 로직 구현
            document.getElementById("schedulePopup").style.display = "none";

            // 입력 필드 초기화
            document.getElementById("itemName").value = '';
            // 필요에 따라 다른 입력 필드도 초기화

            selectedEvent = null; // 선택된 이벤트 초기화
        }

        closeBtn.onclick = function () {
            closePopup(); // 닫기 버튼 클릭 시 팝업 닫기
        };

        window.onclick = function (event) {
            if (event.target == modal) {
                closePopup(); // 모달 외부 클릭 시 팝업 닫기
            }
        };

        // 일정 생성 버튼 클릭 시
        document.getElementById("createScheduleBtn").addEventListener("click", function () {
            const itemName = document.getElementById("itemName").value;
            const purchaseCycle = document.getElementById("purchaseCycle").value;
            const alarmDays = document.getElementById("alarmDays").value;

            if (!itemName || !alarmDays || !selectedDate) {
                alert("생필품 이름과 알람 설정을 입력하세요.");
                return;
            }

            // 선택한 날짜에 새로운 일정 추가
            calendar.addEvent({
                title: itemName,
                start: selectedDate, // 저장한 날짜를 사용
                allDay: true, // 하루 종일 일정
                // 필요에 따라 다른 속성 추가
            });

            closePopup(); // 팝업 닫기
        });

// 일정 수정 버튼 클릭 시
        document.getElementById("updateScheduleBtn").addEventListener("click", function () {
            const itemName = document.getElementById("itemName").value;

            if (!itemName || !selectedDate) {
                alert("일정 이름을 입력하세요.");
                return;
            }

            // 수정된 일정으로 업데이트
            selectedEvent.setProp('title', itemName);
            selectedEvent.setStart(selectedDate); // 선택한 날짜로 수정

            closePopup(); // 팝업 닫기
        });
    });
</script>
<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<!-- 팝업을 위한 모달 -->
<div id="schedulePopup" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>생필품 일정 관리</h2>

        <!-- 생필품 입력 -->
        <label for="itemName">생필품 이름:</label>
        <input type="text" id="itemName" placeholder="생필품 이름을 입력하세요" /><br /><br />

        <!-- 구매 주기 선택 -->
        <label for="purchaseCycle">구매 주기:</label>
        <select id="purchaseCycle">
            <option value="7">1주일</option>
            <option value="14">2주일</option>
            <option value="30">1개월</option>
            <option value="60">2개월</option>
            <option value="90">3개월</option>
        </select><br /><br />

        <!-- 알람 설정 -->
        <label for="alarmDays">알람 (며칠 전에 알림):</label>
        <input type="number" id="alarmDays" placeholder="예: 3" /><br /><br />

        <!-- 버튼들 -->
        <button id="createScheduleBtn">일정 생성</button>
        <button id="updateScheduleBtn">일정 수정</button>
    </div>
</div>
<!-- Flexbox 컨테이너 추가 -->
<div class="flex-container">
    <div id='calendar'></div>
    <div id="List"></div>
</div>

<div id="recommend">
    <!-- 버튼 추가 -->
    <div id="sortButtons">
        <button id="sortByAccuracy">정확도순</button>
        <button id="sortByPrice">최저가순</button>
    </div>

    <!-- 검색 결과를 표시할 곳 -->
    <ul id="resultContainer"></ul> <!-- ul로 변경 -->

    <!-- 페이지네이션 표시 -->
    <div class="pagination" id="paginationContainer">
        <button id="prevPage" class="page-item">이전</button>
        <span id="pageInfo"></span>
        <button id="nextPage" class="page-item">다음</button>
    </div>
    <script>
        let products = []; // 전역 변수로 상품 배열을 선언
        let currentPage = 1; // 현재 페이지
        const itemsPerPage = 5; // 페이지당 아이템 수

        // 페이지 로드 시 자동으로 검색
        document.addEventListener("DOMContentLoaded", function() {
            const query = "%ED%8E%AB%20%EC%9A%A9%ED%92%88";  // 예: "펫 용품"
            searchProducts(query); // 초기 검색 실행
        });

        // 제품 검색 함수
        function searchProducts(query, sort = '') {
            // API 요청 보내기
            fetch('/searchProducts?query=' + query + '&display=' + 100 + sort)
                .then(response => response.json())
                .then(data => {
                    products = data.items; // 전체 상품 데이터를 저장
                    displayResults(products); // 결과 표시
                    setupPagination(products.length); // 페이지네이션 설정
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // 결과를 HTML에 표시하는 함수
        function displayResults(data) {
            const resultContainer = document.getElementById("resultContainer");
            resultContainer.innerHTML = '';  // 기존 내용 초기화

            // 페이지에 따라 데이터 필터링
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            // 각 상품을 화면에 표시
            paginatedData.forEach(item => {
                const productItem = document.createElement('li'); // li 요소 생성
                productItem.classList.add('product-item'); // 클래스 추가
                productItem.innerHTML =
                    `<img src="${item.image}" alt="${item.title}" class="product-image">
                        <div class="product-info">
                            <a href="${item.link}">${item.title}</a>
                            <br>
                            <a href="${item.link}" class="product-price">Price: ${item.lprice} 원</a>
                        </div>`;
                resultContainer.appendChild(productItem); // 리스트에 추가
            });
        }

        // 페이지네이션 설정 함수
        function setupPagination(totalItems) {
            const pageCount = Math.ceil(totalItems / itemsPerPage);
            const pageInfo = document.getElementById("pageInfo");
            pageInfo.innerHTML = `${currentPage} / ${pageCount}`; // 현재 페이지 정보 표시
        }

        // 페이지 변경 함수
        function changePage(direction) {
            const pageCount = Math.ceil(products.length / itemsPerPage);
            if (direction === 'next' && currentPage < pageCount) {
                currentPage++;
            } else if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            }
            displayResults(products); // 필터링된 결과를 다시 표시
            setupPagination(products.length); // 페이지네이션 정보 업데이트
        }

        // 버튼 클릭 이벤트 설정
        document.getElementById("nextPage").addEventListener("click", () => changePage('next'));
        document.getElementById("prevPage").addEventListener("click", () => changePage('prev'));

        // 정렬 기능 설정
        document.getElementById("sortByAccuracy").addEventListener("click", () => {
            products.sort((a, b) => a.accuracy - b.accuracy); // 정확도순 정렬
            displayResults(products); // 정렬된 결과 표시
        });

        document.getElementById("sortByPrice").addEventListener("click", () => {
            products.sort((a, b) => a.lprice - b.lprice); // 가격순 정렬
            displayResults(products); // 정렬된 결과 표시
        });
    </script>
</div>
</body>
</html>